name: ci_cd_pipeline
# run-name: ""
on: [push]
jobs:
    run-kfp-cicd:
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read
        steps:
            - id: auth
              uses: google-github-actions/auth@v1.1.1
              with:
                workload_identity_provider: 'projects/524957214539/locations/global/workloadIdentityPools/gh-tf-pool/providers/gh-tf-provider'
                service_account: 'gh-tf-wip@learn-experiment.iam.gserviceaccount.com'

            - uses: actions/checkout@v3

            - name: Setup python
              uses: actions/setup-python@v4
            
            - name: Install Dependencies
              run: |
                python -m pip install --upgrade pip
                pip install pytest
                cd kf_pipeline
                if [-f requirements.txt]; then pip install -r requirements.txt; fi
            
            - name: Run tests
              run: pytest
            
            - uses: hashicorp/setup-terraform@v2
              with:
                terraform_version: 1.5.3
            
            - name: Terraform init
              id: tf_init
              run: terraform init
              
            - name: Terraform fmt
              id: tf_fmt
              run: terraform fmt -check
            
            - name: Terraform validate
              id: tf_val
              run: terraform validate
            
            - name: Terraform plan
              id: tf_plan
              run: terraform plan -no-color
              env:
                TF_VAR_gh_username: ${{ github.actor }}
                TF_VAR_gh_repo_name: ${{ github.repository }}
                TF_VAR_clone_url: ${{ github.repositoryUrl }}
                TF_VAR_gh_token: ${{ secrets.GITHUB_TOKEN }} 
            
            - name: Terraform apply
              id: tf_apply
              run: terraform apply
              env:
                TF_VAR_gh_username: ${{ github.actor }}
                TF_VAR_gh_repo_name: ${{ github.repository }}
                TF_VAR_clone_url: ${{ github.repositoryUrl }}
                TF_VAR_gh_token: ${{ secrets.GITHUB_TOKEN }}
